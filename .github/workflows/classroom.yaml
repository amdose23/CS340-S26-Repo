name: Verify Regression Test

on:
  pull_request:
    branches:
      - main    # Only run if the PR is targeting the main branch
    paths:
      - '*.py'  # Trigger only on python changes

jobs:
  verify-test-increase:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # CRITICAL: We need full history to compare against 'main'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Verify Bug Fix and Test Increase
        shell: bash
        run: |
          # ---------------------------------------------------------
          # 1. IDENTIFY THE TEST FILE
          # ---------------------------------------------------------
          # Get list of changed python files, excluding the script itself if distinct
          CHANGED_FILES=$(git diff --name-only origin/main HEAD | grep .py)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No python files changed. Skipping."
            exit 0
          fi
          
          # Pick the first relevant test file found
          TEST_FILE=""
          for FILE in $CHANGED_FILES; do
             # If student edited source 'app.py', look for 'test_app.py'
             # If student edited test 'test_app.py', use that.
             if [[ "$FILE" == test_* ]]; then
                TEST_FILE="$FILE"
                break
             elif [ -f "test_$FILE" ]; then
                TEST_FILE="test_$FILE"
                break
             fi
          done

          if [ -z "$TEST_FILE" ]; then
             echo "Could not verify: No matching test file found for the changes."
             exit 0 # Soft exit if they just edited documentation or random files
          fi

          echo "üéØ Validating assignment for: $TEST_FILE"

          # ---------------------------------------------------------
          # 2. RUN STUDENT TESTS (PR Version)
          # ---------------------------------------------------------
          echo "::group::Run Student Tests"

          # Temporarily turn off "exit on error" so we can capture the failure
          set +e
          OUTPUT_PR=$(python3 -m unittest "$TEST_FILE" -v 2>&1)
          EXIT_CODE_PR=$?
          set -e

          echo "$OUTPUT_PR"
          echo "::endgroup::"
          
          # Fail immediately if their code is broken
          if [ $EXIT_CODE_PR -ne 0 ]; then
             echo "‚ùå FAIL: Your tests are failing. Fix the bug first!"
             exit 1
          fi

          # Parse the number of tests run
          # Looks for line: "Ran 5 tests in 0.001s"
          COUNT_PR=$(echo "$OUTPUT_PR" | grep -oE "Ran [0-9]* tests?" | awk '{print $2}')
          echo "‚úÖ Student Test Count: $COUNT_PR"

          # ---------------------------------------------------------
          # 3. RUN BASELINE TESTS (Main Branch)
          # ---------------------------------------------------------
          echo "::group::Run Baseline Tests"
          
          # just extract the original 
          # test file to a temporary location.
          git show origin/main:"$TEST_FILE" > baseline_test.py
          
          # Run the original test file against the student's fixed code.
          # We expect this to pass (proving they didn't break existing functionality).
          OUTPUT_BASE=$(python3 -m unittest baseline_test.py -v 2>&1)
          echo "$OUTPUT_BASE"
          
          # Cleanup the temporary file
          rm baseline_test.py
          echo "::endgroup::"

          # Parse baseline count from the temp file output
          COUNT_BASE=$(echo "$OUTPUT_BASE" | grep -oE "Ran [0-9]* tests?" | awk '{print $2}')
          
          # Fallback for empty/missing baseline (shouldn't happen in your repo)
          if [ -z "$COUNT_BASE" ]; then COUNT_BASE=0; fi
          
          echo "üìä Baseline Test Count: $COUNT_BASE"

          # ---------------------------------------------------------
          # 4. THE VERDICT
          # ---------------------------------------------------------
          if [ "$COUNT_PR" -gt "$COUNT_BASE" ]; then
             echo "üéâ SUCCESS: You added $(($COUNT_PR - $COUNT_BASE)) new test(s)!"
             exit 0
          else
             echo "‚ùå FAIL: No new tests detected."
             echo "   - Baseline tests: $COUNT_BASE"
             echo "   - Your tests:     $COUNT_PR"
             echo "   You must add a regression test case that reproduces the bug."
             exit 1
          fi
